
Microscale particulate flows play a pivotal role in many biophysical settings.
In particular, blood flows through vasculature can be modeled with reasonable accuracy by a collection of deformable particles called \textit{vesicles} suspended in a Newtonian fluid.
A clear understanding blood circulation through capillaries would shed light on important yet complex phenomena such as vasodilation, vasoconstriction, thrombosis and clotting.
The ability to simulate such flows with modern computers would provide a means to computationally investigate these phenomena with an unprecidented level of control and resolution and is a crucial milestone in the pursuit of the next generation of biological advances.
The computational tools required for blood flow simulations can also be applied in other biological settings.
By simulating deterministic lateral displacement microfluidic chip, one can optimize the device geometry and avoid the typical expensive trial-and-error manufacturing process \cite{kabacaouglu2019sorting}.
By simulating intra-cellular dynamics of organelles, researchers can gain insights into biophysical dynamics by adjusting model formulations and infer biological behaviors by comparing experimental and computational results \cite{nazockdast2017cytoplasmic}. 
With better computational tools, more complex systems can be investigated computationally, rapidly increasing the pace of biological innovation.
In this work, however, we will restrict our attention to red blood cell (\rbc) flows through capillaries.

We present a robust scalable platform to simulate \rbc flows through capillaries. 
We first construct a solver for elliptic partial differential equations (\pdes) that robustly handles complex geometries.
We then extend and parallelize this solver, along with a collision-free time stepping scheme, to advect \rbcs along viscous flows.
We scale this solver to nearly 35,000 cores and millions of \rbcs, demonstrating its ability to capture high fidelity real-world biological phenomena.

\section{Background}
The fluid dynamics of blood flow, or \textit{hemodynamics}, spans several regimes. 
The first regime is in larger veins and arteries, and in regions near the heart, where dynamical impact of \rbcs are largely negligible and blood can be well characterized as a non-viscous continuum. 
The second regime is very small length scales ($\leq 80 \mu$m \todo{reference}) such as capillaries, called microcirculation.
In this setting, blood vessel diameter can equal the length of 5-10 \rbcs \todo{reference}, so the overall flow dynamics are largely determined by \rbcs. 
 This implies also that the blood plasma has negligible inertial fluid forces (Reynolds number $Re \leq 10^{-3}$) and can be characterized as a viscous Newtontian fluid \cite{cortinovis2006capillary}.
The final, most complex length scale to study is the transition between these two regimes.%, which we will call the \textit{transitory} regime.
This regime contains length scales varying over three orders of magnitude, implying variable plasma viscosity and non-trivial \rbc flow contributions.
In the non-viscous regime, there are many simulations of the heart and associated vasculature (\todo{find some}).
We will focus on the microcirculation in this work, since target applications such as vasoconstriction, thombosis and clotting occuring in this regime are difficult to investigate experimentally.

\rbcs are somewhat unique cellular structures. 
They contain no nucleus or mitochondira, in order to maximize its capacity to transport hemoglobin \cite{zhang2011red} and have a biconcave shape at rest to maximize large-scale lamniar flow and minimize platelet scattering \cite{uzoigwe2006human}.
Most importantly, \rbcs are highly \textit{deformable}, allowing them to travel through capillaries much narrower than their resting diameter \cite{huisjes2018squeezing}.
Macroscopic physiological mutations, such as sickle cell anemia and thalassemia, are known to impact the degree of \rbc deformability \cite{huisjes2018squeezing}, indicated its importance in the overall dynamics.
This deformability comes from constiuents of its thin cell membrane: the cytoskeleton and a phospholipid bilayer .
Due to the complex membrane structure, \rbc membranes are also extremely resistant to in-plane shear forces and membrane extension \cite{lee2008theoretical}.
Together, these characteristics allow \rbc flow dynamics to be well-approximated by a thin, deformable, inextensible membrane filled with a viscous Newtontian fluid called a \textit{vesicle} \todo{cite}.

In summary, in order to model microcirculation through capillaries, we must:
\begin{itemize}
    \item represent blood plasma as a viscous Newtontian fluid within a blood vessel
    \item approximate \rbcs as a thin, deformable, fluid-filled membrane 
    \item incorporate \rbc membrane inextensibility along with tension and bending forces within the membrane.
\end{itemize}

\section{Challenges}
To faithfully simulate \rbc flows, there are several outstanding compuatational obstacles.
The first is \textit{robustness}: can we design a set of algorithms that can handle arbtirary flows?
Typical flows are characterized by complex vascular geometry, high-volume fraction flows (>45\% in humans) and long simulation times. 
This will result in nearly-touching and potentially colliding geometries that causes many standard simulation approaches to fail; our algorithms need to handle these adversarial cases.
Another challenge is \textit{accuracy}: can we reliably control the numerical error of our algorithms?
We would like accuracy of our simulation to correspond to the accuracy of our physical model, not to the accuracy of our algorithms.
Ideally, one would hope for a single parameter that can be tuned to control the overall numerical error.

Constructing accurate and robust numerical algorithms is demanding in its own right, but as little as a microliter of human blood can contain almost four million \rbcs.
This imposes a final computational challenge: in order to simulate several microliters of blood, our algorithms must be \textit{fast} and \textit{scalable}.
Achieving algorithmic complexity proportional to the number of cells size while guaranteeing robustness and high accuracy is a tall order.
Moreover, the representation of millions of \rbcs and the blood vessel vastly exceeds the memory capcity of a single machine, so distributed algorithms are needed to complete the simulation with reasonable walltime.

There has been a vast amount of work trying to address these shortcomings. 
There are many works successfully scaling blood flow simulations up to hundreds of thousands \cite{grinberg2011new,rossinelli2015silico} or even millions \cite{gounley2017computational,randles2015massively} of cores.
While these methods are able to simulate immense complex geometries, the particle-based simulation approaches taken in these papers, such as lattice Boltzmann and dissipative particle dynamics, naturally incur very high numerical errors.
It remains to be seen whether these errors allow such methods to recover small-scale qualitative behaviors of \rbc flows.

On the other extreme, many recent works have focused on producing highly accurate numerical algorithms of deformable particulate flows using the \textit{boundary integral equation method} \cite{Veerapaneni2009b,Veerapaneni2011,rahimian2015,sorgentone2018highly,sorgentone20193d,af2016fast,Zhao2010}.
Several works \cite{lu2018parallel,Malhotra2017,rahimian2010petascale} have produced scalable parallel versions of these algorithms applied to \rbcs with great success.
However, the majority of this work involved free-space or periodic boundary conditions, which are not relevant in a realistic biophysical setting.
Similar mathematical formulations can be applied to simulating elliptic \pdes \cite{YBZ,wala20183d,wala2018optimization,bruno2013high}, providing efficient, accurate numerical solutions on complex geometries.
A recent paper has leverage these principles into an exascale parallel acoustic scattering simulation \cite{abduljabbar2019extreme}, which along with \cite{rahimian2010petascale} demonstrate that large scale \bie approaches are achievable.

\section{Overall Approach}
Motivated by our previous discussion of the physical properties of \rbc flows, we approximate the physical behavior of individual \rbcs by vesicles and assume that the surrounding fluid is highly viscous and Newtonian.
We will refer to \rbcs and vesicles interchangeably throughout the remainder of this work.
The blood vessel is a rigid closed fluid-filled domain. 
However, such flows are far too complex for analytic solutions and require numerical simulation to study any large system of biological significance.

Since the \rbcs and blood vessel are both bounded by smooth surfaces, we adopt a \textit{boundary integral formulation} of the fluid flow through the vessel.
In brief, a boundary integral formulation allows us to express the fluid velocity at a point in the blood vessel as a sum of integrals, each one defined on the distinct surfaces bounding the fluid.
We can evaluate these integrals on the surface of \rbcs and advect them along the fluid's trajectory. 

This approach has many other advantages. 
It avoids discretizing the fluid volume and avoids the expensive, error-prone process of remeshing at each timestep.
We are able to leverage quadrature methods for smooth functions to produce highly accurate integration.
Well-formulated integral equations have favorable conditioning when discretized, allowing iterative solvers like \gmres to converge in a constant number of steps.
With an appropriate discretization, fast summation methods such as the Fast Multipole Method (\fmm) can evaluate the resulting linear system matrix with optimal complexity.

The primary difficulty introduced by the boundary integral formulation is the need to evaluate integrals of singular functions or functions with rapidly varying high-order derivatives. These are call \textit{singular} and \textit{near-singular} integrals, respectively.
These integrals are well-defined mathematically, but standard numerical quadrature methods fail to resolve their true value.
Special algorithms are required in order to accurately evaluate such integrals.

Two recent papers \cite{barnett2014evaluation,KBGO} introduce a straightforward method called \textit{Quadrature by Expansion}, or \qbx, that approximates a singular/near-singular integral with a local expansion, whose coefficients are defined by smooth integrals.
\qbx has since evolved rapidly, with variations \cite{ST,aT1,RBZ,af2016fast} and analyses \cite{EGK,aT2,klinteberg2020quadrature} for various \pdes and fast accelerations \cite{RKO,wala20193d,wala2019optimization,wala2020approximation}.
Although several \threed implementations have been developed, \cite{ST, wala2019optimization,wala2020approximation, wala20193d}, \threed solvers have been tested on relatively benign geometries.
In practical engineering scenarios, geometries often come from CAD files based on splines or B\'ezier curves that have rapidly varying curvatures and nearly touching, non-local surface patches.
Moreover, the large scale nature of realistic problems require efficient and scalable parallel implementations to be competitive with state-of-the-art finite element implementations.

There is also a rich literature regarding vesicle simulations based on boundary integral formulations \todo{cite them}.
Fast and accurate parallel algorithms have been developed and scaled to thousands of cores. 
However, much is this work is either in \twod \todo{cite} or a free-space or periodic setting in \threed.
To recover qualitative properties of \rbc flows, the vesicles need to simulated in a confined flow with representative vessel geometries (i.e., more complicated than a cylinder/torus).
\todo{boundary integral}
\begin{itemize}
    \item Rigid boundary: qbx
    \item vesicle: shravan, abtin, dhairya etc.
\end{itemize}

\section{Contributions and Outline}
This thesis overcomes these obstacles, resulting in a practical simulation platform for realistic \rbc flows through capillaries.
In particular, this thesis will proceed as follows.

In \Cref{chp:hedgehog}, we introduce an $O(N)$ high-order solver for elliptic \pdes in \threed geometries.
The core component of the solver is \qbkix, a straightforward \pde-independent singular/near-singular quadrature scheme for layer potentials arising from \pdes defined on domains with spline-based boundaries.
We design addaptive geometric preprocessing and query algorithms to gurantee the accuracy of \qbkix while enabling good performance. 
We evaluate the method on a variety of complex geometries and boundary conditions and stress test it on several challenging geometries
This is based on the work in \cite{morse2020robust}.

In \Cref{chp:bloodflow}, we present a robust scalable bloodflow simulation platform. 
We parallelize the \pde solver presented in \cref{chp:hedgehog} to scale to thousands of processors.
We then integrate this with several parallel \rbc simulation libraries. 
In partiular, we extend a collision-free time-stepping scheme for deformable bodies to also handle rigid boundaries.
We explore strong and weak scaling of our plaform and scale this simulation to thousands of cores.
This is based on the work in \cite{lu2019scalable}.

